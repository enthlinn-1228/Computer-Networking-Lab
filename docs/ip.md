# IP 文档
网络层向上提供简单灵活的、无连接的、尽最大努力交付的数据报服务。网络层不用先建立连接，不提供服务质量的承诺。
分组不进行编号，并且所传送的分组有可能丢失、出错、重复和失序，也不保证交付时限。

![](imgs/ip1.png)

#### 网络层两种重要的功能：
1. 转发 将分组从路由器的入链路转发到出链路。
2. 路由选择 当分组从发送方流向接收方时，网络层必须决定这些分组所采用的路由或路径。

#### 将网络互相连接起来的中间设备
1. 物理层使用的中间设备叫做转发器。
2. 数据链路层使用的中间设备叫做网桥或桥接器。
3. 网络层使用的中间设备叫路由器。
4. 在网络层以上使用的中间设备叫网关。

## IP 数据报格式
![](imgs/ip6.png)

1. 版本，4位，现在使用的版本有 IPv4、IPv6。
2. 首部长度，4位，常用首部长度为 20 字节，当首部长度不是 4 的整数倍时，需要填充字节。
3. 区分服务，8位，用来获得更好的服务，一般不使用。
4. 总长度，16位，首部长度 + 数据长度，最大为 2**16 - 1 = 65535 字节。
5. 标识，16位，IP 软件维持一个计数时，每产生一个数据报，计数器就加 1。当数据报长度超过网络的 MTU 而必须分片时，标识字段的值会被复制到所有的分片的标识字段中，为了最后能正确地重装为原来的数据报。
6. 标志，3位，最低位 MF = 1 时，表示后面还有分片，MF = 0 时，表示这是最后一个分片。中间的一位为 DF，DF = 1 时，表示不能分片， DF = 0 时，表示允许分片。
7. 片偏移，13位，分组在分片后，某分片在原分组中的相对位置，即相对于数据字段的起点，该片从何处开始。片偏移以 8 个字节为偏移单位，即分片长度为 8 字节的整数倍。

![](imgs/ip7.png)

![](imgs/ip8.png)

8. 生存时间，8位，英文缩写 TTL，最大值为 255。路由器每次转发数据报之前，把 TTL 减 1，若减到为 0，则丢弃这个数据报。
9. 协议，8位，指出此数据报携带的数据使用何种协议，以便目的主机的 IP 层知道应将数据部分上交给哪个协议进行处理。

![](imgs/ip9.png)

10. 首部检验和，16位，只检验数据报的首部字段，不包括数据部分，每经过一个路由器都要重新计算首部校验和。
11. 源地址，32位。
12. 目的地址，32位。
13. 选项字段，用来支持排错、测试以及安全等措施。

## IP 转发分组流程
在路由表中，对每一条路由最重要的信息是：（目的网络地址，下一跳地址）。

路由器转发分组流程：
1. 从数据报首部提取出目的主机的 IP 地址 D，得出目的网络地址为 N。
2. 若 N 是路由器直接相连的某个网络，则进行直接交付（直接把数据报交给目的主机），否则就是间接交付，执行 3。
3. 若路由表中有目的地址为 D 的特定主机路由或到达网络 N 的路由，则把数据报交给表中所指明的下一跳路由器，否则执行 4。
4. 若路由表中有默认路由，则把数据报交给表中指明的默认路由器，否则执行 5。
5. 报告转发分组出错。

#### 与 IP 协议配套使用的还有三个协议：
1. 地址解析协议 ARP。
2. 网际控制报文协议 ICMP。
3. 网际组管理协议 IGMP。

![](imgs/ip2.png)

## IP 地址
IP 地址由网络号和主机号组成，它是分等级的地址结构。分等级有两个好处：
1. IP 地址管理机构在分配地址时只分配网络号，主机号由该网络号的单位自行分配，管理方便。
2. 路由器仅根据目的地址的网络号来转发分组，这样可以减少路由表中的项目数。

### IP 地址的编址方法经历了三个阶段
1. 分类的 IP 地址。
2. 子网的划分。
3. 构成超网。

### 地址分类
A B C 类地址是单播地址（一对一），D类地址为多播地址（一对多），E类地址保留，每一类地址由两个固定长度的字段组成。
1. 网络号，它标志主机或路由器所连接到的网络。
2. 主机号，它标志主机或路由器。
```
IP 地址 = {网络号,主机号}
```
一个网络是指具有相同网络号的主机的集合，因此用转发器或网桥连接起来的若干个网络仍为同一个网络。

注意，近年来已经广泛使用无分类 IP 地址进行路由选择，A B C 类地址的区分已成为历史。

IP 地址中全 0 表示这个（this），网络号字段全 0 的 IP 地址是个保留地址，意思是本网络。

全 0 的主机号字段表示该 IP 地址是本主机所连接到的单个网络地址（5.6.7.8 该主机所在的网络地址就是 5.0.0.0），全 1 的主机号字段表示该网络上的所有主机。

网络号为 127 保留作为本地软件环回测试本主机的进程之间的通信之用。若主机发送一个目的地址为环回地址的 IP 数据报，则不会把数据报发送到任何网络。
网络号为 127 的地址永远不会出现在网络上，因为它不是一个网络地址。

#### A 类地址
A 类地址主机号占 3 个字节。最大主机数为 2**24 - 2，A 类地址空间约占整个 IP 地址空间的 50%。
#### B 类地址
B 类地址主机号占 2 个字节，最大主机数为 2**16 - 2，B 类地址空间约占整个 IP 地址空间的 25%。
#### C 类地址
C 类地址主机号占 1 个字节，最大主机数为 2**8 - 2，C 类地址空间约占整个 IP 地址空间的 12.5%。

![](imgs/ip3.png)

![](imgs/ip4.png)

#### 其他特点
1. IP 地址标志着一台主机（或路由器）和一条链路的接口。
2. 路由器具有两个或以上的 IP 地址。
3. 两个路由器直连的特殊网络通常不分配地址，这样的特殊网络叫无编号网络或无名网络。
4. IP 地址放在 IP 数据报首部，硬件地址（MAC）放在 MAC 帧的首部。
5. IP 数据报中的源和目的地址始终不变，MAC 帧中的源和目的地址在不同的网络上都会变化。

![](imgs/ip5.png)


### 子网划分
划分子网的方法是从网络的主机号借若干位用作子网号，主机号也相应减少同样的位数。于是两级 IP 地址变成三级 IP 地址。
```
IP 地址 = {<网络号>, <子网号>, <主机号>}
```
单位路由器接收到外网的 IP 数据报后，根据网络号和子网号找到目的子网，再交给对应的主机。

#### 子网掩码
假如一个 IP 数据报（目的地址 145.13.3.10）到达了路由器，怎么分辨这个目的主机所连的网络是否进行了子网划分？
不管有没有进行子网划分，只要把 IP 地址和子网掩码进行按位与，就能得到网络地址。

![](imgs/ip10.png)

![](imgs/ip11.png)


所有的网络都必须使用子网掩码。
1. A 类地址默认子网掩码 255.0.0.0
2. B 类地址默认子网掩码 255.255.0.0
3. C 类地址默认子网掩码 255.255.255.0

#### 使用子网时分组的转发
使用子网后，路由表必须包括：目的网络地址、子网掩码、下一跳地址。

使用子网时转发分组流程：
1. 从数据报首部提取出目的主机的 IP 地址 D。
2. 对路由器直接相连的网络进行这样的操作：用各网络的子网掩码与 D 按位与，得出网络地址，看这个地址是否与相应的网络地址匹配，若匹配则直接交付，否则执行 3。
3. 若路由表中有目的地址为 D 的特定主机路由，则把数据报交给表中所指明的下一跳路由器，否则执行 4。
4. 对路由表中的每一行信息（目的网络地址，子网掩码，下一跳地址），用其中的子网掩码与 D 按位与，得出网络地址 N。若 N 与该行的目的网络地址匹配，则把数据报交给该行指明的下一跳路由，否则执行 5。
5. 若路由表中有默认路由，则把数据报交给表中指明的默认路由器，否则执行 6。
6. 报告转发分组出错。

### 无分类编址，构造超网

#### 网络前缀
无分类域间路由选择（CIDR）:
1. 消除了地址分类以及划分子网的概念，把 32 位 IP 地址分为前后两部分。
```
IP 地址 = {<网络前缀>, <主机号>}
```
CIDR 使三级编址又回到了两级编址，但这是无分类编址。CIDR 使用斜线记法，在 IP 地址后面加上 “/”，然后写上网络前缀的位数（10.0.0.0/10）。

2. CIDR 把网络前缀都相同的 IP 地址组成一个 CIDR 地址块。知道这个地址块中的任意一个地址，就能知道地址块的起始地址和最大地址、地址数量。

![](imgs/ip12.png)

3. CIDR 使用 32 位的地址掩码，其中 1 的个数就是网络前缀的长度。
4. 由于 CIDR 地址块包含很多地址，所以在路由表中就利用 CIDR 地址块查找目的网络，这种地址的聚合称为路由聚合。

#### 最长前缀匹配（最佳匹配）
使用 CIDR 时，路由表项目由网络前缀和下一跳地址组成，但在查找时可能会匹配到不止一个结果，这时要采用最长前缀匹配。